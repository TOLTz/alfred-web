<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alfred</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body {
      margin: 0;
      background: #0b0b10;
      color: #f5f5f7;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
    }

    .top {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      font-weight: 800;
      letter-spacing: .4px;
    }

    .card {
      background: #12121a;
      border: 1px solid #242433;
      border-radius: 14px;
      padding: 14px;
      margin-top: 14px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      cursor: pointer;
      font-weight: 700;
    }

    .btn.primary {
      background: #7c3aed;
      color: white;
    }

    .btn.ghost {
      background: #1a1a25;
      color: #fff;
      border: 1px solid #2a2a36;
    }

    .btn.danger {
      background: #ef4444;
      color: white;
    }

    .btn.ok {
      background: #22c55e;
      color: white;
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .muted {
      color: #a3a3b2;
      font-size: 14px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #2a2a36;
      background: #141420;
      font-size: 13px;
      color: #e5e5f0;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 860px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .k {
      color: #a3a3b2;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .sep {
      height: 1px;
      background: #242433;
      margin: 10px 0;
    }

    input,
    textarea {
      background: #0d0d14;
      border: 1px solid #242433;
      color: #fff;
      border-radius: 12px;
      padding: 10px 12px;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">AlfredAI</div>
      <div class="row">
        <span class="pill"><span class="k">Mesa</span> <span id="mesaLbl">‚Äî</span></span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-size:18px;font-weight:800;">Fazer pedido por voz</div>
          <div class="muted">Grave, envie, edite a comanda e confirme.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <button class="btn primary" id="btnGravar">üéôÔ∏è Pressione para pedir</button>
          <button class="btn danger" id="btnParar" disabled>‚èπÔ∏è Parar</button>
          <button class="btn ghost" id="btnBaixar" disabled>‚¨áÔ∏è Baixar √°udio</button>
        </div>
        <div class="row">
          <span class="pill" id="statusPill">Idle</span>
          <span class="muted" id="jobLbl"></span>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div>
          <div class="k">Pr√©via do √°udio</div>
          <audio id="audioPreview" controls style="width:100%; margin-top:8px;"></audio>
          <div class="muted" style="margin-top:10px;">
            Se quiser conferir se gravou certo, use ‚ÄúBaixar √°udio‚Äù.
          </div>
        </div>

        <div>
          <div class="k">Comanda (edit√°vel)</div>
          <textarea id="comandaText" placeholder="Depois que processar, o texto vai aparecer aqui..." disabled></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn ok" id="btnConfirmar" disabled>‚úÖ Confirmar pedido</button>
            <button class="btn ghost" id="btnRefazer" disabled>üîÅ Refazer</button>
          </div>
          <div class="muted" id="confirmMsg" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://alfred-api-27ade05d8916.herokuapp.com";

    const el = (id) => document.getElementById(id);

    const mesaLbl = el("mesaLbl");
    const statusPill = el("statusPill");
    const jobLbl = el("jobLbl");

    const btnGravar = el("btnGravar");
    const btnParar = el("btnParar");
    const btnBaixar = el("btnBaixar");
    const audioPreview = el("audioPreview");

    const comandaText = el("comandaText");
    const btnConfirmar = el("btnConfirmar");
    const btnRefazer = el("btnRefazer");
    const confirmMsg = el("confirmMsg");

    let mesaId = new URLSearchParams(location.search).get("mesa") || "‚Äî";

    let mediaRecorder = null;
    let chunks = [];
    let audioBlob = null;

    let jobId = null;
    let jobResult = null;
    let sse = null;
    let pollingTimer = null;

    function setStatus(text) {
      statusPill.textContent = text;
    }

    function cleanupWaiters() {
      if (sse) { try { sse.close(); } catch { } sse = null; }
      if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
    }

    function resetUI() {
      jobId = null;
      jobResult = null;
      jobLbl.textContent = "";
      comandaText.value = "";
      comandaText.disabled = true;
      btnConfirmar.disabled = true;
      btnRefazer.disabled = true;
      confirmMsg.textContent = "";
    }

    function buildSimpleComandaText(resultObj, mesaId) {
      const mesaLine = mesaId && mesaId !== "‚Äî" ? `Mesa ${mesaId}` : `Mesa ‚Äî`;
      const lines = [];

      lines.push(`COMANDA - ${mesaLine}`);
      lines.push("");

      const items = Array.isArray(resultObj?.items) ? resultObj.items : [];
      if (items.length) {
        lines.push("Itens:");
        for (const it of items) {
          const name = it?.name || it?.item_id || "Item";
          const qty = Number(it?.quantity ?? 1);
          lines.push(`- ${qty}x ${name}`);
        }
      } else {
        lines.push("Itens:");
        lines.push("- (nenhum item identificado, chame um gar√ßom)");
      }

      const transcript = (resultObj?.transcript || "").trim();
      if (transcript) {
        lines.push("");
        lines.push("Voc√™ falou:");
        lines.push(transcript);
      }

      lines.push("");
      lines.push("Observa√ß√µes:");
      lines.push("(se precisar, escreva aqui)");

      return lines.join("\n");
    }

    async function postAudio() {
      resetUI();
      cleanupWaiters();
      setStatus("Enviando...");

      const fd = new FormData();
      fd.append("file", audioBlob, "pedido.webm");

      const res = await fetch(`${API_BASE}/audio`, { method: "POST", body: fd });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`Erro /audio: ${res.status} ${t}`);
      }

      const data = await res.json();
      jobId = data.job_id;
      jobLbl.textContent = `job_id: ${jobId}`;
      setStatus("Processando...");

      startSSE(jobId);
      startPollingFallback(jobId);
    }

    function onJobDone(result) {
      jobResult = result;
      comandaText.value = buildSimpleComandaText(result, mesaId);
      comandaText.disabled = false;
      setStatus("Pronto para confirmar");
      btnConfirmar.disabled = false;
      btnRefazer.disabled = false;
      cleanupWaiters();
    }

    function onJobFailed() {
      setStatus("Falhou");
      confirmMsg.textContent = "Falha ao processar. Tente novamente.";
      btnRefazer.disabled = false;
      cleanupWaiters();
    }

    function startSSE(id) {
      try {
        sse = new EventSource(`${API_BASE}/events/${id}`);
        sse.onmessage = (evt) => {
          if (!evt.data) return;
          try {
            const parsed = JSON.parse(evt.data);
            if (parsed && parsed.status === "failed") return onJobFailed();
            return onJobDone(parsed);
          } catch {
            return onJobDone({ transcript: "", items: [] });
          }
        };
        sse.onerror = () => { };
      } catch { }
    }

    function startPollingFallback(id) {
      pollingTimer = setInterval(async () => {
        if (!id || jobResult) return;
        try {
          const res = await fetch(`${API_BASE}/jobs/${id}`);
          if (!res.ok) return;
          const data = await res.json();
          if (data.status === "finished") {
            onJobDone(data.result);
          } else if (data.status === "failed") {
            onJobFailed();
          }
        } catch { }
      }, 1200);
    }

    async function confirmOrder() {
      if (!jobId || !jobResult) return;
      btnConfirmar.disabled = true;
      confirmMsg.textContent = "Confirmando...";

      const payload = {
        job_id: jobId,
        mesa_id: mesaId,
        order: jobResult,
        customer_text: comandaText.value || ""
      };

      const res = await fetch(`${API_BASE}/orders/confirm`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const t = await res.text().catch(() => "");
        confirmMsg.textContent = `Erro ao confirmar: ${res.status} ${t}`;
        btnConfirmar.disabled = false;
        return;
      }

      const data = await res.json();
      confirmMsg.textContent = `Pedido confirmado! order_id: ${data.order_id}`;
    }

    btnGravar.addEventListener("click", async () => {
      resetUI();
      cleanupWaiters();
      confirmMsg.textContent = "";

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());
        audioBlob = new Blob(chunks, { type: "audio/webm;codecs=opus" });
        const url = URL.createObjectURL(audioBlob);
        audioPreview.src = url;

        btnBaixar.disabled = false;
        btnRefazer.disabled = false;

        try {
          await postAudio();
        } catch (err) {
          setStatus("Erro");
          confirmMsg.textContent = String(err?.message || err);
        } finally {
          btnGravar.disabled = false;
          btnParar.disabled = true;
        }
      };

      mediaRecorder.start();
      setStatus("Gravando...");
      btnGravar.disabled = true;
      btnParar.disabled = false;
      btnBaixar.disabled = true;
      btnRefazer.disabled = true;
    });

    btnParar.addEventListener("click", () => {
      if (!mediaRecorder) return;
      mediaRecorder.stop();
      btnParar.disabled = true;
      setStatus("Gerando √°udio...");
    });

    btnBaixar.addEventListener("click", () => {
      if (!audioBlob) return;
      const url = URL.createObjectURL(audioBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `pedido_mesa_${mesaId}.webm`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    });

    btnConfirmar.addEventListener("click", confirmOrder);

    btnRefazer.addEventListener("click", () => {
      cleanupWaiters();
      resetUI();
      setStatus("Idle");
    });

    mesaLbl.textContent = mesaId;
    setStatus("Idle");
  </script>
</body>

</html>
